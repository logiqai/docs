# How To Set Up SSO Using Azure AD

Apica supports Single Sign-On (SSO) using SAML with Azure AD.

If you have with Azure Active Directory (Azure AD) you can leverage it for SSO into ASM.

| **Step**                                                                                                                                                                                                                                                    | **Screenshot** |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| Ensure that SAML is enabled.                                                                                                                                                                                                                                |                |
| <p>Go to the <a href="https://wpm.apicasystem.com/">ASM</a> portal.</p><p>As a customer administrator open the <strong>Settings</strong> -> <a href="https://wpm.apicasystem.com/AccountSso/SamlDetails"><strong>Single Sign-On (SAML 2.0)</strong></a></p> |                |
|                                                                                                                                                                                                                                                             |                |

## Azure Portal <a href="#howtosetupssousingazuread-azureportal" id="howtosetupssousingazuread-azureportal"></a>

| **Step**                                                                                                                                                                                                                                                                             | **Screenshot**                            |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------- |
| Go to [the Azure Portal](https://portal.azure.com/) as a user who has administrative rights.                                                                                                                                                                                         | ![](../../.gitbook/assets/2134869154.png) |
| <p>Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/Overview"><strong>Enterprise Applications</strong></a></p><p>- <strong>[1]</strong>, find an existing application <strong>[2]</strong> or add a new one <strong>[3]</strong></p> | ![](../../.gitbook/assets/2134869151.png) |
| When adding a new application select Non-gallery application **\[1]**, type preferred name **\[2]**, and press "**Add**"                                                                                                                                                             | ![](../../.gitbook/assets/2134869148.png) |
| On the application properties select **Single sign-on** **\[1]** and choose **Mode**: "**SAML-based Sign-on**" **\[2]**                                                                                                                                                              | ![](../../.gitbook/assets/2134869145.png) |
|                                                                                                                                                                                                                                                                                      |                                           |

## Configuring SAML in both Azure and ASM <a href="#howtosetupssousingazuread-configuringsamlinbothazureandasm" id="howtosetupssousingazuread-configuringsamlinbothazureandasm"></a>

### ASM as Service Provider endpoints <a href="#howtosetupssousingazuread-asmasserviceproviderendpoints" id="howtosetupssousingazuread-asmasserviceproviderendpoints"></a>

| **Step**                                                                                                                                                                                                                                                                                                                                                | **Screenshot**                                                                                                                                                                      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>Fill <strong>Identifier</strong> <strong>[1]</strong> and <strong>Reply URL</strong> <strong>[2]</strong> from ASM SAML settings</p><p><strong>SERVICE PROVIDER</strong> section:</p><p><strong>Service Provider Entity ID</strong> <strong>[1]</strong> and <strong>Assertation Consumer Service</strong> URL <strong>[2]</strong> respectively</p> | <p><strong>Azure</strong></p><p></p><p><strong>ASM</strong></p><p></p>                                                                                                              |
| <p><strong>Certificate</strong></p><p>Set up SAML Signing Certificate in Azure</p><ul><li><strong>Download</strong> it (Base64)</li></ul>                                                                                                                                                                                                               |                                                                                                                                                                                     |
| Use it in ASM, Signing Certificate **\[1]**                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                     |
| <h3 id="howtosetupssousingazuread-attributes">Attributes</h3><p>Set up user attributes required by ASM in Azure</p>                                                                                                                                                                                                                                     |                                                                                                                                                                                     |
| Itâ€™s important to remember that attributes can be set up with namespaces in Azure. Like this                                                                                                                                                                                                                                                            |                                                                                                                                                                                     |
| Set up **SAML ATTRIBUTE STATEMENTS MAPPING** in ASM respectively.                                                                                                                                                                                                                                                                                       | <p></p><p>If namespaces are used, then they should be included in Attributes Mapping together with attribute names</p>                                                              |
| Set up **ROLES MAPPING** in ASM (tooltips explain everything and give an example). Simple test setting for the "Identity Provider Roles Mapping" property can be used as shown                                                                                                                                                                          | <p><code>{"ASM_Azure_User":{"roles":["CustomerUser"]}}</code></p><p></p><p>Note that role settings in Azure are not explained in her and are the subject of a separate section.</p> |

It's also possible to set up ASM Monitor Groups access in the "Identity Provider Roles Mapping" property. See the JSON example in the tooltip and you might need to use ASM API to [get Monitor Groups IDs](http://api-wpm.apicasystem.com/v3/Help/Route/GET-groups).

### Azure Active Directory Security Groups integration <a href="#howtosetupssousingazuread-azureactivedirectorysecuritygroupsintegration" id="howtosetupssousingazuread-azureactivedirectorysecuritygroupsintegration"></a>

For your Active Directory users to get access to ASM, first set up your Azure Enterprise Application.

| **Step**                                                                                                                                                                                                                                                                                                                                                                                 | **Screenshot**                                                                                                                                                                                                                                                                                                                                         |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| <p>In Enterprise Application / <strong>Properties</strong> <strong>[1]</strong> change "<strong>User assignment required?</strong>" <strong>[2]</strong> to "No" if you want all your Active Directory users to be authorized in the application. </p><p>If you choose "Yes" there, then you need to select exact users in "<strong>Users and groups</strong>" <strong>[3]</strong>.</p> |                                                                                                                                                                                                                                                                                                                                                        |
| In Azure Active Directory **\[1]** choose App registrations **\[2]** and your application **\[3]**:                                                                                                                                                                                                                                                                                      | ![](../../.gitbook/assets/2134869115.png)                                                                                                                                                                                                                                                                                                              |
| <p>Then select Manifest <strong>[1]</strong> and find "groupMembershipClaims" property <strong>[2]</strong> in the JSON.</p><p>The original value of the groupMembershipClaims property is null. Change it to "<strong>SecurityGroup</strong>". It will add users security groups GUIDs returned in SAML token with the attribute name.</p>                                              | ![](../../.gitbook/assets/2134869112.png)                                                                                                                                                                                                                                                                                                              |
| Set this name in **SAML ATTRIBUTE STATEMENTS MAPPING** / **Identity Provider Roles** **\[1]** and use relevant Active Directory Groups GUIDs in the **Identity Provider Roles Mapping** **\[2]**                                                                                                                                                                                         | <p></p><p>So when the user is authenticated by Azure Enterprise Application ASM will get the SAML Token and assign ASM roles to this user using "Identity Provider Roles Mapping". Note that if no ASM roles match the user's Azure Security Groups then ASM will not authenticate this user. There must be at least "CustomerUser" role matching.</p> |
|                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                        |

### Azure as Identity Provider endpoints <a href="#howtosetupssousingazuread-azureasidentityproviderendpoints" id="howtosetupssousingazuread-azureasidentityproviderendpoints"></a>

| **Step**                                                                                                                                                                                                                                              | **Screenshot**                                                           |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| Press "Configure Apica Synthetic Monitoring (ASM)"  **\[1]** (if it was the name of your application in Azure)                                                                                                                                        |                                                                          |
| Follow the documentation you see. Take the values for **SAML Single Sign-On Service URL** **\[1]** and **SAML Entity ID \[2]** to respectively fill these properties into ASM **Sign-In URL** **\[1]** and **Identity Provider Entity ID** **\[2]** : | <p><strong>Azure:</strong></p><p></p><p><strong>ASM:</strong></p><p></p> |
| To find out what GUID is what group in the Azure portal browse to User and groups - All Groups, select the group and here you can see the GUID under Object ID                                                                                        | ![](../../.gitbook/assets/2134869097.png)                                |

## Testing <a href="#howtosetupssousingazuread-testing" id="howtosetupssousingazuread-testing"></a>

After you complete these steps described above you can use "Test" to try authentication in test mode.
